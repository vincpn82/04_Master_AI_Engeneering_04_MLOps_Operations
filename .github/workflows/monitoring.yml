name: Model Monitoring

on:
  # Esegui ogni giorno alle 2:00 UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Permetti esecuzione manuale
  workflow_dispatch:
  
  # Esegui ad ogni push su main
  push:
    branches: [ main ]

jobs:
  monitor:
    name: Monitor Model Performance
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run monitoring script
      run: |
        python monitoring/monitoring.py
    
    - name: Upload monitoring reports
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-reports-${{ github.run_number }}
        path: monitoring/reports/
        retention-days: 90
    
    - name: Check for performance degradation
      id: check_metrics
      run: |
        echo "Controllando le metriche del modello..."
        python -c "
        import pandas as pd
        from pathlib import Path
        import os
        
        # Trova l'ultimo report
        reports = sorted(Path('monitoring/reports').glob('metrics_*.csv'))
        if not reports:
            print('‚ö†Ô∏è Nessun report trovato')
            exit(0)
        
        # Leggi metriche
        df = pd.read_csv(reports[-1])
        accuracy = df['accuracy'].iloc[0]
        f1_score = df['f1_score'].iloc[0]
        threshold = 0.69
        
        print(f'üìä Accuracy: {accuracy:.4f}')
        print(f'üìä F1-Score: {f1_score:.4f}')
        print(f'üéØ Soglia: {threshold}')
        
        # Scrivi variabili d'ambiente per lo step successivo
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            if accuracy < threshold:
                f.write(f'DEGRADED=true\n')
                f.write(f'ACCURACY={accuracy:.4f}\n')
                f.write(f'F1_SCORE={f1_score:.4f}\n')
                print('‚ùå Performance sotto soglia - verr√† creato un issue')
            else:
                f.write(f'DEGRADED=false\n')
                print('‚úÖ Performance accettabile')
        "
    
    - name: Create issue if degraded
      if: env.DEGRADED == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '‚ö†Ô∏è Model Performance Degradation Detected',
            body: `## üö® Alert: Performance Degradation\n\n` +
                  `Il modello ha mostrato performance sotto la soglia accettabile.\n\n` +
                  `### üìä Metriche Rilevate\n` +
                  `- **Accuracy**: ${process.env.ACCURACY}\n` +
                  `- **F1-Score**: ${process.env.F1_SCORE}\n` +
                  `- **Soglia minima**: 0.69\n\n` +
                  `### üîó Riferimenti\n` +
                  `- **Run**: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
                  `- **Timestamp**: ${new Date().toISOString()}\n\n` +
                  `### üõ†Ô∏è Azioni Consigliate\n` +
                  `- [ ] Analizza i report di monitoraggio\n` +
                  `- [ ] Verifica la distribuzione dei dati\n` +
                  `- [ ] Considera il retraining del modello\n` +
                  `- [ ] Valuta il fine-tuning con dati recenti`,
            labels: ['model-monitoring', 'alert', 'performance']
          });
